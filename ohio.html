<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ULTRABLOCK: DETERMINATION PROTOCOL</title>
<style>
body{
    margin:0;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    background:black;
    font-family:monospace;
}
canvas{
    background:#111;
    border:4px solid red;
    box-shadow:0 0 25px red;
}
</style>
</head>
<body>

<canvas id="game" width="400" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let keys={}, frame=0, gameOver=false;
let stage=0; // 0=platformer,1=rain,2=lasers,3=boss
let score=0;

/* ================= PLAYER ================= */
const player={
    x:180,y:520,w:20,h:20,
    vx:0,vy:0,
    speed:5,
    gravity:0.6,
    onGround:false,
    color:"#00faff",
    update(){
        if(keys.ArrowLeft) this.vx=-this.speed;
        else if(keys.ArrowRight) this.vx=this.speed;
        else this.vx=0;

        if(keys.ArrowUp && this.onGround){
            this.vy=-12;
            this.onGround=false;
        }

        this.vy+=this.gravity;
        this.x+=this.vx;
        this.y+=this.vy;

        this.x=Math.max(0,Math.min(canvas.width-this.w,this.x));
        if(this.y>canvas.height){
            gameOver=true;
        }
    },
    draw(){
        ctx.fillStyle=this.color;
        ctx.shadowBlur=15;
        ctx.shadowColor=this.color;
        ctx.fillRect(this.x,this.y,this.w,this.h);
        ctx.shadowBlur=0;
    }
};

/* ================= PLATFORMS ================= */
const platforms=[
    {x:50,y:450,w:100,h:10},
    {x:250,y:380,w:100,h:10},
    {x:100,y:300,w:120,h:10},
    {x:200,y:220,w:120,h:10}
];

function platformCollision(){
    player.onGround=false;
    platforms.forEach(p=>{
        if(player.x+player.w>p.x &&
           player.x<p.x+p.w &&
           player.y+player.h>p.y &&
           player.y+player.h<p.y+10 &&
           player.vy>=0){
            player.y=p.y-player.h;
            player.vy=0;
            player.onGround=true;
        }
    });
}

/* ================= BLOCK RAIN ================= */
let blocks=[];
function spawnBlock(){
    blocks.push({
        x:Math.random()*380,
        y:-20,
        w:20,h:20,
        speed:4+score*0.1
    });
}

/* ================= LASERS ================= */
let lasers=[];
function spawnLaser(){
    lasers.push({
        x:Math.random()*350,
        w:40,
        warn:40,
        fire:20
    });
}

/* ================= BOSS ================= */
let bossPhase=0, bossTimer=0;
let bullets=[];

function spawnBullet(x,y,vx,vy){
    bullets.push({x,y,vx,vy,size:8});
}

/* ================= COLLISION ================= */
function hit(a,b){
    return a.x<b.x+b.size &&
           a.x+a.w>b.x &&
           a.y<b.y+b.size &&
           a.y+a.h>b.y;
}

/* ================= UPDATE ================= */
function update(){
    if(gameOver) return;

    player.update();
    if(stage===0||stage===1) platformCollision();

    /* -------- STAGE 0: PLATFORMER -------- */
    if(stage===0){
        if(player.y<150){
            stage=1;
            player.y=520;
        }
    }

    /* -------- STAGE 1: BLOCK RAIN -------- */
    if(stage===1){
        if(frame%30===0) spawnBlock();

        for(let i=blocks.length-1;i>=0;i--){
            blocks[i].y+=blocks[i].speed;
            if(hit(player,{...blocks[i],size:blocks[i].w})){
                gameOver=true;
            }
            if(blocks[i].y>600){
                blocks.splice(i,1);
                score++;
            }
        }
        if(score>=20){
            stage=2;
            blocks=[];
        }
    }

    /* -------- STAGE 2: LASERS -------- */
    if(stage===2){
        if(frame%90===0) spawnLaser();
        for(let i=lasers.length-1;i>=0;i--){
            let l=lasers[i];
            l.warn--;
            if(l.warn<=0){
                l.fire--;
                if(player.x<l.x+l.w &&
                   player.x+player.w>l.x){
                    gameOver=true;
                }
            }
            if(l.fire<=0) lasers.splice(i,1);
        }
        if(frame>1200){
            stage=3;
            lasers=[];
            player.y=450;
        }
    }

    /* -------- STAGE 3: BOSS -------- */
    if(stage===3){
        bossTimer++;

        if(bossTimer%30===0){
            spawnBullet(Math.random()*400,-10,0,4+bossPhase);
        }

        bullets.forEach(b=>{
            b.x+=b.vx;
            b.y+=b.vy;
            if(hit(player,b)) gameOver=true;
        });

        bullets=bullets.filter(b=>b.y<650);

        if(bossTimer>400){
            bossPhase++;
            bossTimer=0;
            bullets=[];
            if(bossPhase>3) gameOver=true;
        }
    }

    frame++;
}

/* ================= DRAW ================= */
function draw(){
    ctx.clearRect(0,0,400,600);

    platforms.forEach(p=>{
        ctx.fillStyle="#555";
        ctx.fillRect(p.x,p.y,p.w,p.h);
    });

    blocks.forEach(b=>{
        ctx.fillStyle="red";
        ctx.fillRect(b.x,b.y,b.w,b.h);
    });

    lasers.forEach(l=>{
        if(l.warn>0){
            ctx.strokeStyle="rgba(255,0,0,0.5)";
            ctx.strokeRect(l.x,0,l.w,600);
        }else{
            ctx.fillStyle="white";
            ctx.fillRect(l.x,0,l.w,600);
        }
    });

    bullets.forEach(b=>{
        ctx.fillStyle="white";
        ctx.fillRect(b.x,b.y,b.size,b.size);
    });

    player.draw();

    ctx.fillStyle="white";
    ctx.fillText(`STAGE ${stage}`,10,20);
    ctx.fillText(`SCORE ${score}`,10,40);

    if(gameOver){
        ctx.fillStyle="rgba(255,0,0,0.5)";
        ctx.fillRect(0,0,400,600);
        ctx.fillStyle="white";
        ctx.textAlign="center";
        ctx.font="30px monospace";
        ctx.fillText("YOU DIED",200,300);
        ctx.font="16px monospace";
        ctx.fillText("Refresh to Retry",200,340);
    }
}

/* ================= LOOP ================= */
function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
}

addEventListener("keydown",e=>keys[e.key]=true);
addEventListener("keyup",e=>keys[e.key]=false);

loop();
</script>
</body>
</html>