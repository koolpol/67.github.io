<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ULTRABLOCK: PRO MAX</title>
    <style>
        body {
            margin: 0;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: monospace;
        }

        canvas {
            background: #111;
            border: 4px solid red;
            box-shadow: 0 0 30px red;
        }
    </style>
</head>
<body>
<canvas id="game" width="400" height="600"></canvas>
<script>
    /* ================= CORE ================= */
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const keys = {};
    let frame = 0;
    let gameOver = false;
    let stage = 0;

    /* ================= PLAYER ================= */
    const player = {
        x: 190,
        y: 530,
        w: 20,
        h: 20,
        vx: 0,
        vy: 0,
        speed: 5,
        jump: 12,
        gravity: 0.6,
        onGround: false,
        color: "#00faff",
        soulMode: "blue", // Blue = Gravity, Red = Free, Purple = Lines
        reset() {
            this.x = 190;
            this.y = 530;
            this.vx = 0;
            this.vy = 0;
        },
        update() {
            if (this.soulMode === "blue") {
                if (keys.ArrowLeft) this.vx = -this.speed;
                else if (keys.ArrowRight) this.vx = this.speed;
                else this.vx = 0;
                if (keys.ArrowUp && this.onGround) {
                    this.vy = -this.jump;
                    this.onGround = false;
                }
                this.vy += this.gravity;
            } else if (this.soulMode === "red") {
                this.vx = keys.ArrowLeft ? -this.speed : keys.ArrowRight ? this.speed : 0;
                this.vy = keys.ArrowUp ? -this.speed : keys.ArrowDown ? this.speed : 0;
            }

            this.x += this.vx;
            this.y += this.vy;
            if (this.x < 0) this.x = 0;
            if (this.x + this.w > canvas.width) this.x = canvas.width - this.w;
            if (this.y < 0) this.y = 0;
            if (this.y + this.h > canvas.height) this.y = canvas.height - this.h;
            if (this.y > canvas.height - 5 && this.soulMode === "blue") this.onGround = true;
        },
        draw() {
            ctx.fillStyle = this.soulMode === "blue" ? "#006aff" : "#ff0000";
            ctx.shadowBlur = 15;
            ctx.shadowColor = ctx.fillStyle;
            ctx.fillRect(this.x, this.y, this.w, this.h);
            ctx.shadowBlur = 0;
        }
    };

    /* ================= HAZARDS ================= */
    const blocks = [];
    const lasers = [];
    const bullets = [];
    const bones = [];
    let bossTimer = 0;
    let bossPhase = 0;

    function rectHit(a, b) {
        return (a.x < b.x + (b.w || b.size) && a.x + a.w > b.x && a.y < b.y + (b.h || b.size) && a.y + a.h > b.y);
    }

    /* ================= STAGE 5: NO MERCY ================= */
    function updateStage5() {
        bossTimer++;

        // 1. SANS: Gravity Manipulation (Flipping gravity randomly)
        if (bossTimer % 120 === 0) {
            player.gravity *= -1;
            player.jump *= -1;
        }

        // 2. PAPYRUS: Bone Gaps (Coming from the right)
        if (bossTimer % 40 === 0) {
            let gapY = Math.random() * 400 + 100;
            bones.push({x: 400, y: 0, w: 20, h: gapY - 50}, {x: 400, y: gapY + 50, w: 20, h: 600});
        }

        // 3. MUFFET: Purple Trap (Restricting movement to horizontal lanes)
        if (bossTimer > 300) {
            player.soulMode = "red";
            player.speed = 3; // Slow down
        }

        // 4. FLOWEY: The "Friendliness Pellets" Circle (Guaranteed Hit)
        if (bossTimer % 100 === 0) {
            for (let i = 0; i < 12; i++) {
                let angle = (i / 12) * Math.PI * 2;
                bullets.push({
                    x: player.x + Math.cos(angle) * 150,
                    y: player.y + Math.sin(angle) * 150,
                    vx: -Math.cos(angle) * 4,
                    vy: -Math.sin(angle) * 4,
                    size: 10
                });
            }
        }

        // Move Bones
        bones.forEach((b, i) => {
            b.x -= 6;
            if (rectHit(player, b)) gameOver = true;
            if (b.x < -20) bones.splice(i, 1);
        });

        // Move Bullets
        bullets.forEach((b, i) => {
            b.x += b.vx;
            b.y += b.vy;
            if (rectHit(player, b)) gameOver = true;
        });
    }

    /* ================= MAIN LOOP ================= */
    function update() {
        if (gameOver) return;
        player.update();

        if (stage === 0 && player.y < 120) {
            stage = 1;
            player.reset();
        } else if (stage === 1) {
            if (frame % 30 === 0) blocks.push({x: Math.random() * 380, y: -20, size: 20, speed: 4});
            blocks.forEach((b, i) => {
                b.y += b.speed;
                if (rectHit(player, b)) gameOver = true;
                if (b.y > 600) blocks.splice(i, 1);
            });
            if (frame > 600) {
                stage = 2;
                blocks = [];
                player.reset();
            }
        } else if (stage === 2) {
            if (frame % 60 === 0) lasers.push({x: Math.random() * 360, w: 40, warn: 40, fire: 20});
            lasers.forEach((l, i) => {
                l.warn--;
                if (l.warn <= 0) {
                    l.fire--;
                    if (player.x < l.x + l.w && player.x + player.w > l.x) gameOver = true;
                }
                if (l.fire <= 0) lasers.splice(i, 1);
            });
            if (frame > 1200) {
                stage = 3;
                lasers = [];
                player.reset();
            }
        } else if (stage === 3) {
            bossTimer++;
            if (bossTimer % 20 === 0) bullets.push({x: Math.random() * 400, y: -10, vx: 0, vy: 6, size: 10});
            bullets.forEach((b, i) => {
                b.y += b.vy;
                if (rectHit(player, b)) gameOver = true;
                if (b.y > 600) bullets.splice(i, 1);
            });
            if (bossTimer > 400) {
                stage = 5;
                bossTimer = 0;
                bullets = [];
                player.reset();
            }
        } else if (stage === 5) {
            updateStage5();
        }
        frame++;
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw Bones
        ctx.fillStyle = "white";
        bones.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));

        // Draw Other
        blocks.forEach(b => {
            ctx.fillStyle = "red";
            ctx.fillRect(b.x, b.y, b.size, b.size);
        });
        lasers.forEach(l => {
            ctx.fillStyle = l.warn > 0 ? "rgba(255,0,0,0.3)" : "white";
            ctx.fillRect(l.x, 0, l.w, 600);
        });
        bullets.forEach(b => {
            ctx.fillStyle = "#ffff00";
            ctx.fillRect(b.x, b.y, b.size, b.size);
        });

        player.draw();
        ctx.fillStyle = "white";
        ctx.fillText(`STAGE ${stage}`, 10, 20);
        if (stage === 5) {
            ctx.fillStyle = "red";
            ctx.fillText("BUT NOBODY CAME.", 150, 20);
        }

        if (gameOver) {
            ctx.fillStyle = "rgba(0,0,0,0.8)";
            ctx.fillRect(0, 0, 400, 600);
            ctx.fillStyle = "red";
            ctx.textAlign = "center";
            ctx.font = "30px monospace";
            ctx.fillText("STAY DETERMINED", 200, 300);
        }
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    addEventListener("keydown", e => keys[e.key] = true);
    addEventListener("keyup", e => keys[e.key] = false);
    loop();
</script>
</body>
</html>